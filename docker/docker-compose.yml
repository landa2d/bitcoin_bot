# OpenClaw AgentPulse — Multi-Service Docker Compose
# 3 services: gato (Telegram agent), analyst (analysis worker), processor (background scraper)
#
# Secrets (SUPABASE_URL, OPENAI_API_KEY, etc.) come from env_file: ../config/.env
# Only non-secret, service-specific vars are set in the environment block.

x-common-env: &common-env
  AGENTPULSE_ENABLED: "true"
  AGENTPULSE_OPENAI_MODEL: gpt-4o

services:
  # ═══════════════════════════════════════════════════════
  # GATO — User-facing Bitcoin agent (Telegram)
  # ═══════════════════════════════════════════════════════
  gato:
    build:
      context: .
      dockerfile: gato/Dockerfile
    container_name: openclaw-gato
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      <<: *common-env
      AGENT_NAME: gato
      NODE_ENV: production
      NODE_OPTIONS: --max-old-space-size=1536
      OPENCLAW_DATA_DIR: /home/openclaw/.openclaw
      OPENCLAW_SKILLS_DIR: /home/openclaw/skills
      OPENCLAW_GATEWAY_MODE: local
      LOG_LEVEL: info
    volumes:
      - ../data/openclaw/agents/main:/home/openclaw/.openclaw/agents/main
      - ../data/openclaw/workspace:/home/openclaw/.openclaw/workspace
      - ../skills:/home/openclaw/skills:ro
      - ../config:/home/openclaw/.openclaw/config:ro
      - ../config/persona.md:/home/openclaw/persona.md:ro
    mem_limit: 2g
    networks:
      - agentpulse-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════
  # ANALYST — Headless analysis worker
  # ═══════════════════════════════════════════════════════
  analyst:
    build:
      context: ./analyst
      dockerfile: Dockerfile
    container_name: openclaw-analyst
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      <<: *common-env
      AGENT_NAME: analyst
      ANALYST_POLL_INTERVAL: "10"
      TELEGRAM_BOT_TOKEN: ""
      TELEGRAM_OWNER_ID: ""
      NODE_ENV: production
      NODE_OPTIONS: --max-old-space-size=1536
      OPENCLAW_DATA_DIR: /home/openclaw/.openclaw
      OPENCLAW_SKILLS_DIR: /home/openclaw/skills
      OPENCLAW_GATEWAY_MODE: local
      LOG_LEVEL: info
    volumes:
      - ../data/openclaw/agents/analyst:/home/openclaw/.openclaw/agents/analyst
      - ../data/openclaw/workspace:/home/openclaw/.openclaw/workspace
      - ../skills:/home/openclaw/skills:ro
      - ../config:/home/openclaw/.openclaw/config:ro
    mem_limit: 2g
    depends_on:
      - processor
    networks:
      - agentpulse-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════
  # NEWSLETTER — Headless editorial agent
  # ═══════════════════════════════════════════════════════
  newsletter:
    build:
      context: ./newsletter
      dockerfile: Dockerfile
    container_name: agentpulse-newsletter
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      <<: *common-env
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      AGENT_NAME: newsletter
      NODE_ENV: production
      NODE_OPTIONS: --max-old-space-size=1536
      OPENCLAW_DATA_DIR: /home/openclaw/.openclaw
      OPENCLAW_SKILLS_DIR: /home/openclaw/skills
      OPENCLAW_GATEWAY_MODE: local
      LOG_LEVEL: info
    volumes:
      - ../data/openclaw/agents/newsletter:/home/openclaw/.openclaw/agents/newsletter
      - ../data/openclaw/workspace:/home/openclaw/.openclaw/workspace
      - ../skills:/home/openclaw/skills:ro
      - ../config:/home/openclaw/.openclaw/config:ro
    mem_limit: 512m
    depends_on:
      - processor
    networks:
      - agentpulse-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════
  # PROCESSOR — Background scraper & task orchestrator
  # ═══════════════════════════════════════════════════════
  processor:
    build:
      context: ./processor
      dockerfile: Dockerfile
    container_name: agentpulse-processor
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      <<: *common-env
    volumes:
      - ../data/openclaw/workspace:/home/openclaw/.openclaw/workspace
      - ../config:/home/openclaw/.openclaw/config:ro
    mem_limit: 256m
    networks:
      - agentpulse-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "python3", "-c", "print('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  agentpulse-net:
    driver: bridge
