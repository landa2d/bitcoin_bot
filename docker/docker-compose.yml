# OpenClaw AgentPulse — Multi-Service Docker Compose
# 6 services: gato (Telegram), analyst, processor, research, newsletter, web
#
# Monday pipeline: scrapers → analyst → spotlight selection → research agent → newsletter
# Secrets (SUPABASE_URL, OPENAI_API_KEY, etc.) come from env_file: ../config/.env
# Only non-secret, service-specific vars are set in the environment block.

x-common-env: &common-env
  AGENTPULSE_ENABLED: "true"
  AGENTPULSE_OPENAI_MODEL: deepseek-chat
  GITHUB_TOKEN: ${GITHUB_TOKEN:-}

services:
  # ═══════════════════════════════════════════════════════
  # GATO — User-facing Bitcoin agent (Telegram)
  # ═══════════════════════════════════════════════════════
  gato:
    build:
      context: .
      dockerfile: gato/Dockerfile
    container_name: openclaw-gato
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      <<: *common-env
      AGENT_NAME: gato
      NODE_ENV: production
      NODE_OPTIONS: --max-old-space-size=1536
      OPENCLAW_DATA_DIR: /home/openclaw/.openclaw
      OPENCLAW_SKILLS_DIR: /home/openclaw/skills
      OPENCLAW_GATEWAY_MODE: local
      LOG_LEVEL: info
    volumes:
      - ../data/openclaw/agents/main:/home/openclaw/.openclaw/agents/main
      - ../data/openclaw/workspace:/home/openclaw/.openclaw/workspace
      - ../skills:/home/openclaw/skills:ro
      - ../config:/home/openclaw/.openclaw/config:ro
      - ../config/persona.md:/home/openclaw/persona.md:ro
    mem_limit: 2g
    networks:
      - agentpulse-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════
  # ANALYST — Direct OpenAI intelligence agent
  # ═══════════════════════════════════════════════════════
  analyst:
    build:
      context: ./analyst
      dockerfile: Dockerfile
    container_name: agentpulse-analyst
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      <<: *common-env
      AGENT_NAME: analyst
      ANALYST_POLL_INTERVAL: "15"
      ANALYST_MODEL: deepseek-chat
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      DEEPSEEK_BASE_URL: ${DEEPSEEK_BASE_URL:-https://api.deepseek.com}
      OPENCLAW_DATA_DIR: /home/openclaw/.openclaw
      LOG_LEVEL: info
    volumes:
      - ../data/openclaw/workspace:/home/openclaw/.openclaw/workspace
      - ../data/openclaw/agents/analyst:/home/openclaw/.openclaw/agents/analyst
      - ../skills/analyst:/home/openclaw/.openclaw/skills/analyst:ro
      - ../config:/home/openclaw/.openclaw/config:ro
    mem_limit: 256m
    depends_on:
      processor:
        condition: service_healthy
    networks:
      - agentpulse-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "pgrep", "-f", "analyst_poller.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ═══════════════════════════════════════════════════════
  # NEWSLETTER — Direct Anthropic newsletter writer
  # ═══════════════════════════════════════════════════════
  newsletter:
    build:
      context: ./newsletter
      dockerfile: Dockerfile
    container_name: agentpulse-newsletter
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      <<: *common-env
      AGENT_NAME: newsletter
      OPENCLAW_DATA_DIR: /home/openclaw/.openclaw
      NEWSLETTER_MODEL: deepseek-chat
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      DEEPSEEK_BASE_URL: ${DEEPSEEK_BASE_URL:-https://api.deepseek.com}
      NEWSLETTER_POLL_INTERVAL: "30"
      LOG_LEVEL: info
    volumes:
      - ../data/openclaw/workspace:/home/openclaw/.openclaw/workspace
      - ../data/openclaw/agents/newsletter:/home/openclaw/.openclaw/agents/newsletter
      - ../skills/newsletter:/home/openclaw/.openclaw/skills/newsletter:ro
      - ../config:/home/openclaw/.openclaw/config:ro
    mem_limit: 256m
    depends_on:
      processor:
        condition: service_healthy
    networks:
      - agentpulse-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "pgrep", "-f", "newsletter_poller.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════
  # RESEARCH — Conviction-driven thesis builder (Anthropic)
  # ═══════════════════════════════════════════════════════
  research:
    build:
      context: ./research
      dockerfile: Dockerfile
    container_name: agentpulse-research
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      <<: *common-env
      AGENT_NAME: research
      RESEARCH_MODEL: claude-sonnet-4-20250514
      RESEARCH_POLL_INTERVAL: "60"
      OPENCLAW_DATA_DIR: /home/openclaw/.openclaw
      LOG_LEVEL: info
    volumes:
      - ../data/openclaw/workspace:/home/openclaw/.openclaw/workspace
      - ../config:/home/openclaw/.openclaw/config:ro
      - ../templates/research/IDENTITY.md:/home/openclaw/IDENTITY.md:ro
    mem_limit: 256m
    depends_on:
      processor:
        condition: service_healthy
    networks:
      - agentpulse-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "pgrep", "-f", "research_agent.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ═══════════════════════════════════════════════════════
  # PROCESSOR — Background scraper & task orchestrator
  # ═══════════════════════════════════════════════════════
  processor:
    build:
      context: ./processor
      dockerfile: Dockerfile
    container_name: agentpulse-processor
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      <<: *common-env
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      DEEPSEEK_BASE_URL: ${DEEPSEEK_BASE_URL:-https://api.deepseek.com}
    volumes:
      - ../data/openclaw/workspace:/home/openclaw/.openclaw/workspace
      - ../config:/home/openclaw/.openclaw/config:ro
    mem_limit: 256m
    networks:
      - agentpulse-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "pgrep", "-f", "agentpulse_processor.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ═══════════════════════════════════════════════════════
  # WEB — Newsletter archive (Caddy + static SPA)
  # ═══════════════════════════════════════════════════════
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: agentpulse-web
    restart: unless-stopped
    env_file:
      - ../config/.env
    networks:
      - agentpulse-net
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: aiagentspulse.com
    volumes:
      - caddy-data:/data
      - caddy-config:/config
    mem_limit: 128m
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  agentpulse-net:
    driver: bridge

volumes:
  caddy-data:
  caddy-config:
